<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–∑–∞–∏—á–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .error-text {
      color: #e74c3c;
      font-size: 0.9em;
      margin-top: 5px;
    }
    #preview {
      max-width: 250px;
      margin-top: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß© –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–æ–∑–∞–∏–∫–∏</h1>

    <form id="mosaicForm" action="/generate" method="post" enctype="multipart/form-data">

      <section>
        <h2>1Ô∏è‚É£ –ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h2>
        <input type="file" name="input_image" id="input_image" accept="image/*" required>
        <img id="preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" style="display:none;">
      </section>

      <section>
        <h2>2Ô∏è‚É£ –¢–∞–π–ª—ã</h2>
        <label><input type="radio" name="tiles_mode" value="zip" checked> ZIP –∞—Ä—Ö–∏–≤</label>
        <label><input type="radio" name="tiles_mode" value="images"> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
        <label><input type="radio" name="tiles_mode" value="folder"> –ü–∞–ø–∫–∞</label>

        <div id="tiles_zip_section">
          <input type="file" id="tiles_zip" name="tiles_zip" accept=".zip">
        </div>
        <div id="tiles_images_section" style="display:none;">
          <input type="file" id="tiles_images" name="tiles_images" accept="image/*" multiple>
        </div>
        <div id="tiles_folder_section" style="display:none;">
          <input type="file" id="tiles_folder" name="tiles_folder" webkitdirectory directory multiple>
        </div>

        <div id="tileError" class="error-text"></div>
      </section>

      <section>
        <h2>3Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–∑–∞–∏–∫–∏</h2>
        <label>–†–∞–∑–º–µ—Ä —Ç–∞–π–ª–∞: <input type="number" name="grid" min="1" max="100" step="1" value="30" required></label>
        <label>–®–∞–≥ —Å–µ—Ç–∫–∏: <input type="number" name="stride" min="1" max="200" step="1"></label>
        <label><input type="checkbox" name="rotate"> –†–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–≤–æ—Ä–æ—Ç</label>
        <label>–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∞–π–ª–∞: <input type="number" name="max_usage" value="0" min="0" max="1000"></label>
        <label>–ú–µ—Ç—Ä–∏–∫–∞:
          <select name="metric">
            <option value="color">–¶–≤–µ—Ç</option>
            <option value="color+grad">–¶–≤–µ—Ç + –≥—Ä–∞–¥–∏–µ–Ω—Ç</option>
          </select>
        </label>
        <label>–í–µ—Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞: <input type="number" min="0" max="1" step="0.01" name="grad_weight" value="0.5"></label>
        <label>–ö–æ—Ä—Ä–µ–∫—Ü–∏—è —Ü–≤–µ—Ç–∞ (0‚Äì1): <input type="number" min="0" max="1" step="0.01" name="color_correction" value="0"></label>
        <label>–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —à–≤–æ–≤ (0‚Äì1): <input type="number" min="0" max="1" step="0.01" name="seam_smoothing" value="0"></label>
        <label>–°–º–µ—à–∏–≤–∞–Ω–∏–µ —Å –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–º (0‚Äì1): <input type="number" step="0.01" name="blend" min="0" max="1" value="0"></label>
      </section>

      <button type="submit" class="generate-btn">–°–æ–∑–¥–∞—Ç—å –º–æ–∑–∞–∏–∫—É</button>
    </form>
  </div>

<script>
  // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const inputImage = document.getElementById('input_image');
  const preview = document.getElementById('preview');
  inputImage.addEventListener('change', () => {
    const file = inputImage.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = 'block';
      preview.onload = () => URL.revokeObjectURL(url);
    } else {
      preview.style.display = 'none';
    }
  });

  // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞–π–ª–æ–≤
  const radios = document.querySelectorAll('input[name="tiles_mode"]');
  const zipSection = document.getElementById('tiles_zip_section');
  const imgSection = document.getElementById('tiles_images_section');
  const folderSection = document.getElementById('tiles_folder_section');
  radios.forEach(r => {
    r.addEventListener('change', () => {
      zipSection.style.display = r.value === 'zip' ? 'block' : 'none';
      imgSection.style.display = r.value === 'images' ? 'block' : 'none';
      folderSection.style.display = r.value === 'folder' ? 'block' : 'none';
    });
  });

  // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  const form = document.getElementById("mosaicForm");
  const generateBtn = document.querySelector(".generate-btn");
  const tileError = document.getElementById("tileError");

  const loadingMsg = document.createElement("div");
  loadingMsg.textContent = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–∑–∞–∏–∫–∏... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.";
  loadingMsg.style.display = "none";
  loadingMsg.style.marginTop = "10px";
  loadingMsg.style.color = "#555";
  loadingMsg.style.fontStyle = "italic";
  form.appendChild(loadingMsg);

  form.addEventListener("submit", function(e) {
    tileError.textContent = "";
    let valid = true;
    const mode = document.querySelector('input[name="tiles_mode"]:checked').value;
    if (mode === "zip" && document.getElementById("tiles_zip").files.length === 0) {
      tileError.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç–µ ZIP –∞—Ä—Ö–∏–≤ —Å —Ç–∞–π–ª–∞–º–∏.";
      valid = false;
    }
    if (mode === "images" && document.getElementById("tiles_images").files.length === 0) {
      tileError.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.";
      valid = false;
    }
    if (mode === "folder" && document.getElementById("tiles_folder").files.length === 0) {
      tileError.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å —Ç–∞–π–ª–∞–º–∏.";
      valid = false;
    }

    if (!valid) {
      e.preventDefault();
      return;
    }

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    generateBtn.disabled = true;
    generateBtn.textContent = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...";
    loadingMsg.style.display = "block";
  });
</script>

</body>
</html>
